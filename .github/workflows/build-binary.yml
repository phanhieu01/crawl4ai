name: Build Binary

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.8.0)'
        required: false
        default: 'latest'

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-20.04
            platform: linux-x64
            python: '3.11'
            archive: tar.gz
          - os: windows-2022
            platform: windows-x64
            python: '3.11'
            archive: zip
          - os: macos-13
            platform: macos-x64
            python: '3.11'
            archive: tar.gz
          - os: macos-14
            platform: macos-arm64
            python: '3.11'
            archive: tar.gz

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Install crawl4ai
        run: |
          pip install -e .

      - name: Install Playwright browsers (with dependencies)
        run: |
          playwright install --with-deps chromium

      - name: Get Playwright browsers directory
        id: browser-paths
        shell: bash
        run: |
          # Get Playwright browsers cache directory
          if [ "$RUNNER_OS" == "Windows" ]; then
            PLAYWRIGHT_DIR="$LOCALAPPDATA/ms-playwright"
          elif [ "$RUNNER_OS" == "macOS" ]; then
            PLAYWRIGHT_DIR="$HOME/Library/Caches/ms-playwright"
          else
            PLAYWRIGHT_DIR="$HOME/.cache/ms-playwright"
          fi
          
          echo "playwright_dir=$PLAYWRIGHT_DIR" >> $GITHUB_OUTPUT
          
          echo "ðŸ” Playwright browser directory:"
          echo "  Path: $PLAYWRIGHT_DIR"
          
          if [ -d "$PLAYWRIGHT_DIR" ]; then
            echo "  âœ“ Directory exists"
            du -sh "$PLAYWRIGHT_DIR" 2>/dev/null || echo "  Size: Unable to calculate"
            echo "  Contents:"
            ls -la "$PLAYWRIGHT_DIR" 2>/dev/null || echo "  Unable to list"
          else
            echo "  âœ— Directory NOT found!"
            exit 1
          fi

      - name: Build binary with bundled browsers
        shell: bash
        run: |
          SEPARATOR=":"
          if [ "$RUNNER_OS" == "Windows" ]; then
            SEPARATOR=";"
          fi
          
          pyinstaller crawl4ai/cli.py \
            --name crawl4ai \
            --onefile \
            --console \
            --clean \
            --add-data "crawl4ai/js_snippet${SEPARATOR}crawl4ai/js_snippet" \
            --add-data "${{ steps.browser-paths.outputs.playwright_dir }}${SEPARATOR}ms-playwright" \
            --hidden-import crawl4ai.async_webcrawler \
            --hidden-import crawl4ai.async_crawler_strategy \
            --hidden-import crawl4ai.browser_manager \
            --hidden-import crawl4ai.extraction_strategy \
            --hidden-import crawl4ai.markdown_generation_strategy \
            --hidden-import crawl4ai.chunking_strategy \
            --hidden-import crawl4ai.content_filter_strategy \
            --hidden-import crawl4ai.content_scraping_strategy \
            --hidden-import crawl4ai.deep_crawling \
            --hidden-import crawl4ai.adaptive_crawler \
            --hidden-import crawl4ai.cache_context \
            --hidden-import crawl4ai.async_database \
            --hidden-import playwright \
            --hidden-import patchright \
            --collect-all playwright \
            --collect-all patchright \
            --strip \
            --optimize 2

      - name: Test binary
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            ./dist/crawl4ai.exe --version || echo "Version check failed"
            ./dist/crawl4ai.exe --help || echo "Help check failed"
          else
            chmod +x dist/crawl4ai
            ./dist/crawl4ai --version || echo "Version check failed"
            ./dist/crawl4ai --help || echo "Help check failed"
          fi

      - name: Create archive
        shell: bash
        run: |
          cd dist
          if [ "$RUNNER_OS" == "Windows" ]; then
            7z a crawl4ai-${{ matrix.platform }}.zip crawl4ai.exe
          else
            tar -czf crawl4ai-${{ matrix.platform }}.tar.gz crawl4ai
          fi

      - name: Generate checksum
        shell: bash
        run: |
          cd dist
          if [ "$RUNNER_OS" == "Windows" ]; then
            sha256sum crawl4ai-${{ matrix.platform }}.zip > crawl4ai-${{ matrix.platform }}.zip.sha256
          else
            sha256sum crawl4ai-${{ matrix.platform }}.tar.gz > crawl4ai-${{ matrix.platform }}.tar.gz.sha256
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: crawl4ai-${{ matrix.platform }}
          path: |
            dist/crawl4ai-${{ matrix.platform }}.*
          retention-days: 90

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifact structure
        run: |
          ls -R artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/crawl4ai-linux-x64/crawl4ai-linux-x64.tar.gz
            artifacts/crawl4ai-linux-x64/crawl4ai-linux-x64.tar.gz.sha256
            artifacts/crawl4ai-windows-x64/crawl4ai-windows-x64.zip
            artifacts/crawl4ai-windows-x64/crawl4ai-windows-x64.zip.sha256
            artifacts/crawl4ai-macos-x64/crawl4ai-macos-x64.tar.gz
            artifacts/crawl4ai-macos-x64/crawl4ai-macos-x64.tar.gz.sha256
            artifacts/crawl4ai-macos-arm64/crawl4ai-macos-arm64.tar.gz
            artifacts/crawl4ai-macos-arm64/crawl4ai-macos-arm64.tar.gz.sha256
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Binary Downloads (with bundled browsers)
            
            Choose the appropriate binary for your platform:
            
            - **Linux (x64)**: `crawl4ai-linux-x64.tar.gz`
            - **Windows (x64)**: `crawl4ai-windows-x64.zip`
            - **macOS Intel (x64)**: `crawl4ai-macos-x64.tar.gz`
            - **macOS Apple Silicon (arm64)**: `crawl4ai-macos-arm64.tar.gz`
            
            All binaries include bundled Chromium browsers (~300MB each).
            
            **Verify checksums** using the `.sha256` files before running.
            
            ### Quick Start
            
            **Linux/macOS:**
            ```bash
            tar -xzf crawl4ai-*.tar.gz
            chmod +x crawl4ai
            ./crawl4ai --help
            ```
            
            **Windows:**
            ```cmd
            unzip crawl4ai-windows-x64.zip
            crawl4ai.exe --help
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
